<!DOCTYPE html>
<html lang="en" x-data="{ ...themeManager(), ...staleTabDetector() }" :data-theme="currentTheme">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}} - CoinOps Dashboard</title>
    <link rel="stylesheet" href="/assets/css/pico.min.css">
    <style>
        /* HTMX indicator styles */
        .htmx-indicator { display: none; }
        .htmx-request .htmx-indicator { display: inline; }
        .htmx-request.htmx-indicator { display: inline; }

        /* Notification badge */
        .notification-badge {
            background: var(--pico-primary);
            color: var(--pico-primary-inverse);
            border-radius: 50%;
            padding: 0.1em 0.5em;
            font-size: 0.75em;
            vertical-align: super;
            margin-left: 0.25em;
        }
        .notification-badge:empty { display: none; }

        /* SVG donut timer */
        .donut-timer {
            width: 16px;
            height: 16px;
            display: inline-block;
            vertical-align: middle;
            margin-left: 0.25em;
        }
        .donut-timer circle {
            fill: none;
            stroke-width: 3;
        }
        .donut-bg {
            stroke: var(--pico-muted-border-color);
        }
        .donut-progress {
            stroke: var(--pico-primary);
            stroke-linecap: round;
            transform: rotate(-90deg);
            transform-origin: center;
        }

        /* Theme toggle fieldset */
        .theme-toggle {
            display: flex;
            gap: 1rem;
            margin: 0;
            padding: 0;
            border: none;
        }
        .theme-toggle label {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            cursor: pointer;
            margin: 0;
        }
        .theme-toggle input[type="radio"] {
            margin: 0;
        }

        /* Compact view */
        .compact-view table { font-size: 0.875em; }
        .compact-view td, .compact-view th { padding: 0.5rem; }

        /* Positive/negative change colors */
        .change-positive { color: var(--pico-ins-color, #2a9d8f); }
        .change-negative { color: var(--pico-del-color, #e76f51); }

        /* Settings section */
        .settings-section {
            margin-bottom: 1.5rem;
        }
        .settings-section h4 {
            margin-bottom: 0.5rem;
        }

        /* Stale tab banner */
        .stale-tab-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--pico-primary);
            color: var(--pico-primary-inverse);
            padding: 1rem;
            text-align: center;
            z-index: 9999;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .stale-tab-banner button {
            margin-left: 1rem;
            padding: 0.25rem 1rem;
        }
        body.has-banner {
            padding-top: 4rem;
        }
    </style>
</head>
<body :class="{ 'compact-view': compactView, 'has-banner': showStaleBanner }">
    <!-- Stale Tab Banner -->
    <div x-show="showStaleBanner" x-cloak class="stale-tab-banner">
        <strong>New version available!</strong>
        This tab is running an outdated version of the dashboard.
        <button @click="window.location.reload()">Refresh Now</button>
        <button @click="showStaleBanner = false" style="margin-left: 0.5rem;">Dismiss</button>
    </div>

    <nav class="container-fluid">
        <ul>
            <li><strong>CoinOps Dashboard</strong></li>
        </ul>
        <ul>
            <li>
                <a href="#"
                   id="notifications-link"
                   hx-get="/notifications"
                   hx-target="#notifications-dialog-content"
                   hx-swap="innerHTML"
                   @click="$refs.notificationsDialog.showModal()">
                    <span id="notification-counter">Notifications (<span id="notification-count">{{.NotificationCount}}</span>)</span>
                </a>
            </li>
            <li><a href="#" @click.prevent="$refs.settingsDialog.showModal()">Settings</a></li>
        </ul>
    </nav>

    <main class="container">
        {{template "content" .}}
    </main>

    <footer class="container" style="margin-top: 2rem; padding: 1rem 0; border-top: 1px solid var(--pico-muted-border-color); text-align: center; color: var(--pico-muted-color); font-size: 0.875rem;">
        CoinOps Dashboard {{.Version}} ({{.Commit}}) | {{.CommitDate}}
    </footer>

    <!-- Notifications Dialog -->
    <dialog x-ref="notificationsDialog">
        <article>
            <header>
                <button aria-label="Close" rel="prev" @click="$refs.notificationsDialog.close()"></button>
                <h3>Notifications</h3>
            </header>
            <div id="notifications-dialog-content">
                <p>Loading...</p>
            </div>
            <footer>
                <button @click="$refs.notificationsDialog.close()">Close</button>
            </footer>
        </article>
    </dialog>

    <!-- Settings Dialog -->
    <dialog x-ref="settingsDialog">
        <article>
            <header>
                <button aria-label="Close" rel="prev" @click="$refs.settingsDialog.close()"></button>
                <h3>Settings</h3>
            </header>

            <div class="settings-section">
                <h4>Theme</h4>
                <fieldset class="theme-toggle">
                    <label>
                        <input type="radio" name="theme" value="light"
                               :checked="themeSetting === 'light'"
                               @change="setTheme('light')">
                        Light
                    </label>
                    <label>
                        <input type="radio" name="theme" value="dark"
                               :checked="themeSetting === 'dark'"
                               @change="setTheme('dark')">
                        Dark
                    </label>
                    <label>
                        <input type="radio" name="theme" value="auto"
                               :checked="themeSetting === 'auto'"
                               @change="setTheme('auto')">
                        Auto
                    </label>
                </fieldset>
            </div>

            <div class="settings-section">
                <h4>Display</h4>
                <label>
                    <input type="checkbox" role="switch" x-model="compactView" @change="saveCompactView()">
                    Compact View
                </label>
            </div>

            <footer>
                <button @click="$refs.settingsDialog.close()">Close</button>
            </footer>
        </article>
    </dialog>

    <script src="/assets/js/htmx.min.js"></script>
    <script src="/assets/js/alpine.min.js" defer></script>
    <script>
        // Stale tab detector Alpine.js component
        function staleTabDetector() {
            return {
                clientVersion: null,
                showStaleBanner: false,
                checkInterval: null,

                init() {
                    // Fetch initial version on page load
                    this.fetchMetadata().then(metadata => {
                        if (metadata) {
                            this.clientVersion = metadata.version;
                            console.log('[StaleTab] Client version stored:', this.clientVersion);
                        }
                    });

                    // Poll every 60 seconds to check for updates
                    this.checkInterval = setInterval(() => {
                        this.checkForUpdates();
                    }, 60000);
                },

                async fetchMetadata() {
                    try {
                        const response = await fetch('/metadata');
                        if (!response.ok) {
                            console.error('[StaleTab] Failed to fetch metadata:', response.status);
                            return null;
                        }
                        return await response.json();
                    } catch (error) {
                        console.error('[StaleTab] Error fetching metadata:', error);
                        return null;
                    }
                },

                async checkForUpdates() {
                    const metadata = await this.fetchMetadata();
                    if (!metadata) return;

                    const serverVersion = metadata.version;

                    // If we have a client version and it differs from server version
                    if (this.clientVersion && serverVersion !== this.clientVersion) {
                        console.log('[StaleTab] Version mismatch detected!');
                        console.log('[StaleTab] Client:', this.clientVersion, 'Server:', serverVersion);
                        this.showStaleBanner = true;
                        // Stop polling once we detect a mismatch
                        if (this.checkInterval) {
                            clearInterval(this.checkInterval);
                        }
                    }
                },

                destroy() {
                    if (this.checkInterval) {
                        clearInterval(this.checkInterval);
                    }
                }
            };
        }

        // Theme manager Alpine.js component
        function themeManager() {
            return {
                themeSetting: localStorage.getItem('theme') || 'auto',
                compactView: localStorage.getItem('compactView') === 'true',
                mediaQuery: window.matchMedia('(prefers-color-scheme: dark)'),

                init() {
                    this.mediaQuery.addEventListener('change', () => {
                        if (this.themeSetting === 'auto') {
                            this.currentTheme = this.getSystemTheme();
                        }
                    });
                },

                get currentTheme() {
                    if (this.themeSetting === 'auto') {
                        return this.getSystemTheme();
                    }
                    return this.themeSetting;
                },

                getSystemTheme() {
                    return this.mediaQuery.matches ? 'dark' : 'light';
                },

                setTheme(theme) {
                    this.themeSetting = theme;
                    localStorage.setItem('theme', theme);
                },

                saveCompactView() {
                    localStorage.setItem('compactView', this.compactView);
                }
            };
        }

        // Per-coin ticker component with delay queue
        // Each coin row independently manages its own refresh timing
        function coinTicker(config) {
            return {
                id: config.id,
                delays: config.delays,      // Queue of 10 delays in ms
                currentDelay: 0,            // Current delay being counted down
                remaining: 0,               // Time remaining in ms
                timerId: null,

                startTimer() {
                    if (this.delays.length === 0) return;

                    // Pop the first delay from the queue
                    this.currentDelay = this.delays.shift();
                    this.remaining = this.currentDelay;

                    const startTime = Date.now();

                    this.timerId = setInterval(() => {
                        const elapsed = Date.now() - startTime;
                        this.remaining = Math.max(0, this.currentDelay - elapsed);

                        if (this.remaining <= 0) {
                            clearInterval(this.timerId);
                            // Trigger HTMX to fetch new row (brings fresh queue of 10 delays)
                            htmx.trigger(this.$el, 'refresh');
                        }
                    }, 100);
                },

                get countdown() {
                    return Math.ceil(this.remaining / 1000);
                },

                get progress() {
                    // SVG circle circumference = 2 * PI * 7 â‰ˆ 44
                    if (this.currentDelay === 0) return 0;
                    const percent = this.remaining / this.currentDelay;
                    return 44 * (1 - percent);
                },

                destroy() {
                    if (this.timerId) {
                        clearInterval(this.timerId);
                    }
                }
            };
        }
    </script>
</body>
</html>
